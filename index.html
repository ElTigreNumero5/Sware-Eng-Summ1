<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Front page</title>
    <!-- sets out where to go for styling -->
    <link rel="stylesheet" href="base.css" />
</head>
<body>
    <!-- Sets up the whole screen -->
    <div class="screen_canvas">
        <!-- Sets up only the phone app window within the whole screen-->
        <div class="phone">
            <!-- The chart of historic attendance %s and targets, with its own container-->
            <div>
                <canvas id="historic_attend_chart"></canvas>
            </div>
            <!-- Page title -->
            <h1>Track my attendance</h1>
            <!-- Navigation buttons-->
            <div class="button-row">
                <button type="button" class="button button1" onclick="window.location.assign('inputs.html')">Input attendance</button>
                <button type="button" class="button button2">View attendance</button> 
            </div>
        </div>
    </div>

</body>



<!-- GET THE DATA, BUILD THE CHART -->
<!-- JS to create a global var for updated target (empty for now), needed here as used in chart build -->
<script>
    // will hold an updated target if set
    const targetStored = localStorage.getItem('updatedTarget');
    const updatedTarget = targetStored !== null ? Number(targetStored) : null;  
</script>

<!-- install chart.js from a CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- JS to build the chart, from csv, and if present the updated target-->
<script>

    // this code requests the csv attendance data from a file in the same dir
    fetch('f-page-attend-data.csv')  
        .then(response => response.text())  // when fetch completes convert response to text
        .then(text => {  // using that text
            // strip wspace, split into array of rows, ignore first row col headings
            const rows = text.trim().split('\n').slice(1);  
            // empty arrays for each col, 
            const labels = [];
            const targets = [];
            const attends = [];
            // loop each row, split on commas, get each value and assign to array
            rows.forEach(row => {
                const [label, target, attend] = row.split(',');
                labels.push(label);
                // for targets, use the user entered value if it exists, else csv val
                targets.push(updatedTarget !== null ? updatedTarget : +target);
                attends.push(+attend);
            });
    
            // now build the chart with the data - needs to be within the fetch.then
            const ctx = document.getElementById('historic_attend_chart');  // here's where it goes
            // create a new chart
            new Chart(ctx, {
                type: 'bar',  // a bar chart
                data: {
                    labels: labels,  // y-axis is the labels data
                    datasets: [
                        {label: 'Attendance %', 
                        data: attends,
                        borderWidth: 1,
                        backgroundColor: '#773D98'
                        },
                        {label: 'Target %',
                        data: targets,
                        type: 'line',
                        borderColor: '#AEA4B2',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        customCanvasBackgroundColor: {
                            color: '#404040'
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#AEA4B2',
                                font: {
                                    family: 'KodeMono',
                                    size: 10
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#AEA4B2',
                                font: {
                                    family: 'KodeMono',
                                    size: 10
                                }
                            }
                        }
                    }
                }
            })
        })
</script>

</html>